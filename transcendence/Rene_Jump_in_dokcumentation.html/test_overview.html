<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Service - Code Map</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .legend {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .legend h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .legend-items {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            border: 2px solid #333;
        }
        
        .architecture {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .layer {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .layer:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0,0,0,0.2);
        }
        
        .layer-title {
            font-size: 1.5em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid;
            font-weight: bold;
        }
        
        .layer.entry .layer-title { border-color: #4CAF50; color: #4CAF50; }
        .layer.routes .layer-title { border-color: #2196F3; color: #2196F3; }
        .layer.service .layer-title { border-color: #FF9800; color: #FF9800; }
        .layer.model .layer-title { border-color: #9C27B0; color: #9C27B0; }
        .layer.database .layer-title { border-color: #F44336; color: #F44336; }
        
        .component {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .component:hover {
            background: #e0e0e0;
            transform: translateX(5px);
        }
        
        .layer.entry .component { border-color: #4CAF50; }
        .layer.routes .component { border-color: #2196F3; }
        .layer.service .component { border-color: #FF9800; }
        .layer.model .component { border-color: #9C27B0; }
        .layer.database .component { border-color: #F44336; }
        
        .component-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        
        .component-file {
            color: #666;
            font-size: 0.9em;
            font-family: 'Courier New', monospace;
            margin-bottom: 8px;
        }
        
        .component-desc {
            color: #555;
            font-size: 0.95em;
            line-height: 1.4;
        }
        
        .component-methods {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }
        
        .method {
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            color: #333;
            padding: 3px 0;
        }
        
        .protected {
            display: inline-block;
            background: #ff5722;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.75em;
            margin-left: 5px;
        }
        
        .flow-diagram {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .flow-diagram h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .flow-step {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
            border-left: 4px solid #2196F3;
        }
        
        .flow-number {
            background: #2196F3;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .flow-content {
            flex: 1;
        }
        
        .flow-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .flow-desc {
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê User Service - Code Architektur</h1>
        
        <div class="legend">
            <h3>üìä Legende</h3>
            <div class="legend-items">
                <div class="legend-item">
                    <div class="legend-color" style="background: #4CAF50;"></div>
                    <span>Entry Point (Server)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #2196F3;"></div>
                    <span>Routes (API Endpoints)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #FF9800;"></div>
                    <span>Service Layer (Business Logic)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #9C27B0;"></div>
                    <span>Model Layer (Datenbank-Zugriff)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #F44336;"></div>
                    <span>Database (SQLite)</span>
                </div>
            </div>
        </div>
        
        <div class="architecture">
            <!-- Entry Point -->
            <div class="layer entry">
                <div class="layer-title">üöÄ Entry Point</div>
                
                <div class="component">
                    <div class="component-name">Fastify Server</div>
                    <div class="component-file">src/index.js</div>
                    <div class="component-desc">
                        Haupteinstiegspunkt des User Service. Startet auf Port 3001.
                    </div>
                    <div class="component-methods">
                        <div class="method">‚Ä¢ CORS aktiviert</div>
                        <div class="method">‚Ä¢ Logger aktiviert</div>
                        <div class="method">‚Ä¢ JWT Decorator registriert</div>
                    </div>
                </div>
                
                <div class="component">
                    <div class="component-name">authenticate()</div>
                    <div class="component-file">Fastify Decorator</div>
                    <div class="component-desc">
                        Middleware f√ºr JWT-Validierung. Pr√ºft Authorization Header und verifiziert Token.
                    </div>
                </div>
            </div>
            
            <!-- Routes -->
            <div class="layer routes">
                <div class="layer-title">üõ£Ô∏è API Routes</div>
                
                <div class="component">
                    <div class="component-name">POST /auth/register</div>
                    <div class="component-file">src/index.js:40</div>
                    <div class="component-desc">
                        Registriert neuen User. Erwartet username, email, password.
                    </div>
                    <div class="component-methods">
                        <div class="method">‚Üí AuthService.register()</div>
                    </div>
                </div>
                
                <div class="component">
                    <div class="component-name">POST /auth/login</div>
                    <div class="component-file">src/index.js:65</div>
                    <div class="component-desc">
                        Login f√ºr existierende User. Gibt JWT-Token zur√ºck.
                    </div>
                    <div class="component-methods">
                        <div class="method">‚Üí AuthService.validateUser()</div>
                        <div class="method">‚Üí AuthService.generateToken()</div>
                    </div>
                </div>
                
                <div class="component">
                    <div class="component-name">GET /auth/profile <span class="protected">üîí</span></div>
                    <div class="component-file">src/index.js:96</div>
                    <div class="component-desc">
                        Gibt User-Profil zur√ºck. Ben√∂tigt validen JWT-Token.
                    </div>
                    <div class="component-methods">
                        <div class="method">‚Üí authenticate() middleware</div>
                    </div>
                </div>
                
                <div class="component">
                    <div class="component-name">GET /health</div>
                    <div class="component-file">src/index.js:107</div>
                    <div class="component-desc">
                        Health Check f√ºr Monitoring.
                    </div>
                </div>
            </div>
            
            <!-- Service Layer -->
            <div class="layer service">
                <div class="layer-title">‚öôÔ∏è Service Layer</div>
                
                <div class="component">
                    <div class="component-name">AuthService</div>
                    <div class="component-file">src/services/authService.js</div>
                    <div class="component-desc">
                        Business Logic f√ºr Authentication und User Management.
                    </div>
                    <div class="component-methods">
                        <div class="method">‚Ä¢ register(username, email, password)</div>
                        <div class="method">‚Ä¢ validateUser(username, password)</div>
                        <div class="method">‚Ä¢ generateToken(user)</div>
                        <div class="method">‚Ä¢ login(email, password)</div>
                        <div class="method">‚Ä¢ verifyToken(token)</div>
                        <div class="method">‚Ä¢ updatePassword(userId, old, new)</div>
                    </div>
                </div>
                
                <div class="component">
                    <div class="component-name">register()</div>
                    <div class="component-desc">
                        1. Pr√ºft ob User existiert (Email & Username)<br>
                        2. Hasht Passwort mit bcrypt<br>
                        3. Erstellt User in DB<br>
                        4. Generiert JWT (24h g√ºltig)
                    </div>
                </div>
                
                <div class="component">
                    <div class="component-name">validateUser()</div>
                    <div class="component-desc">
                        1. Sucht User nach Username/Email<br>
                        2. Vergleicht Passwort mit bcrypt<br>
                        3. Gibt User oder null zur√ºck
                    </div>
                </div>
            </div>
            
            <!-- Model Layer -->
            <div class="layer model">
                <div class="layer-title">üì¶ Model Layer</div>
                
                <div class="component">
                    <div class="component-name">User Model</div>
                    <div class="component-file">src/models/User.js</div>
                    <div class="component-desc">
                        Datenbank-Abstraktions-Layer. Alle DB-Operationen f√ºr Users.
                    </div>
                    <div class="component-methods">
                        <div class="method">‚Ä¢ create(userData)</div>
                        <div class="method">‚Ä¢ findById(id)</div>
                        <div class="method">‚Ä¢ findByEmail(email)</div>
                        <div class="method">‚Ä¢ findByUsername(username)</div>
                        <div class="method">‚Ä¢ update(id, updateData)</div>
                        <div class="method">‚Ä¢ delete(id)</div>
                        <div class="method">‚Ä¢ getAllUsers(limit, offset)</div>
                        <div class="method">‚Ä¢ getUserCount()</div>
                        <div class="method">‚Ä¢ exists(id)</div>
                    </div>
                </div>
                
                <div class="component">
                    <div class="component-name">User Schema</div>
                    <div class="component-desc">
                        Fields: id, username, email, password, bio, avatar, 
                        is_two_factor_auth_enabled, two_factor_auth_secret, 
                        forty_two_id, created_at, updated_at
                    </div>
                </div>
            </div>
            
            <!-- Database -->
            <div class="layer database">
                <div class="layer-title">üíæ Database</div>
                
                <div class="component">
                    <div class="component-name">Database Config</div>
                    <div class="component-file">shared/config/database.js</div>
                    <div class="component-desc">
                        Shared SQLite Verbindung f√ºr alle Services.
                    </div>
                    <div class="component-methods">
                        <div class="method">‚Ä¢ dbRun(sql, params) - Promise</div>
                        <div class="method">‚Ä¢ dbGet(sql, params) - Promise</div>
                        <div class="method">‚Ä¢ dbAll(sql, params) - Promise</div>
                    </div>
                </div>
                
                <div class="component">
                    <div class="component-name">SQLite Database</div>
                    <div class="component-file">shared/database/transcendence.db</div>
                    <div class="component-desc">
                        Zentrale Datenbank f√ºr alle Services. Foreign Keys aktiviert.
                    </div>
                </div>
                
                <div class="component">
                    <div class="component-name">Migrations</div>
                    <div class="component-file">shared/database/migrations/001_users.sql</div>
                    <div class="component-desc">
                        Automatisches Migrieren beim Server-Start.
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Flow Diagram -->
        <div class="flow-diagram">
            <h3>üîÑ Authentication Flow (Login)</h3>
            
            <div class="flow-step">
                <div class="flow-number">1</div>
                <div class="flow-content">
                    <div class="flow-title">POST /auth/login</div>
                    <div class="flow-desc">Client sendet { username, password }</div>
                </div>
            </div>
            
            <div class="flow-step">
                <div class="flow-number">2</div>
                <div class="flow-content">
                    <div class="flow-title">AuthService.validateUser()</div>
                    <div class="flow-desc">Service validiert Credentials</div>
                </div>
            </div>
            
            <div class="flow-step">
                <div class="flow-number">3</div>
                <div class="flow-content">
                    <div class="flow-title">User.findByUsername()</div>
                    <div class="flow-desc">Model sucht User in Datenbank</div>
                </div>
            </div>
            
            <div class="flow-step">
                <div class="flow-number">4</div>
                <div class="flow-content">
                    <div class="flow-title">bcrypt.compare()</div>
                    <div class="flow-desc">Passwort-Hash wird verglichen</div>
                </div>
            </div>
            
            <div class="flow-step">
                <div class="flow-number">5</div>
                <div class="flow-content">
                    <div class="flow-title">AuthService.generateToken()</div>
                    <div class="flow-desc">JWT wird generiert (24h g√ºltig)</div>
                </div>
            </div>
            
            <div class="flow-step">
                <div class="flow-number">6</div>
                <div class="flow-content">
                    <div class="flow-title">Response mit Token</div>
                    <div class="flow-desc">Client erh√§lt { access_token, user: {...} }</div>
                </div>
            </div>
        </div>
        
        <div class="flow-diagram">
            <h3>üîÑ Registration Flow</h3>
            
            <div class="flow-step">
                <div class="flow-number">1</div>
                <div class="flow-content">
                    <div class="flow-title">POST /auth/register</div>
                    <div class="flow-desc">Client sendet { username, email, password }</div>
                </div>
            </div>
            
            <div class="flow-step">
                <div class="flow-number">2</div>
                <div class="flow-content">
                    <div class="flow-title">User.findByEmail() & findByUsername()</div>
                    <div class="flow-desc">Pr√ºft ob User bereits existiert</div>
                </div>
            </div>
            
            <div class="flow-step">
                <div class="flow-number">3</div>
                <div class="flow-content">
                    <div class="flow-title">bcrypt.hash(password, 10)</div>
                    <div class="flow-desc">Passwort wird sicher gehasht</div>
                </div>
            </div>
            
            <div class="flow-step">
                <div class="flow-number">4</div>
                <div class="flow-content">
                    <div class="flow-title">User.create()</div>
                    <div class="flow-desc">Neuer User wird in DB erstellt</div>
                </div>
            </div>
            
            <div class="flow-step">
                <div class="flow-number">5</div>
                <div class="flow-content">
                    <div class="flow-title">jwt.sign()</div>
                    <div class="flow-desc">JWT Token wird generiert</div>
                </div>
            </div>
            
            <div class="flow-step">
                <div class="flow-number">6</div>
                <div class="flow-content">
                    <div class="flow-title">Response mit Token</div>
                    <div class="flow-desc">Client erh√§lt { user, token }</div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>