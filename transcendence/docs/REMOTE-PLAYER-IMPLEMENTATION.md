# Remote Player Implementation Guide

## Overview

This document explains how the remote player feature works in ft_transcendence, including the complete architecture, game flow, and technical implementation details for cross-computer gameplay over HTTPS with WebSockets.

## Table of Contents

1. [Architecture Overview](#architecture-overview)
2. [System Architecture Diagram](#system-architecture-diagram)
3. [Game Flow Diagrams](#game-flow-diagrams)
4. [Key Components](#key-components)
5. [WebSocket Message Protocol](#websocket-message-protocol)
6. [Game State Management](#game-state-management)
7. [Configuration](#configuration)
8. [Testing Guide](#testing-guide)
9. [Troubleshooting](#troubleshooting)

---

## Architecture Overview

The remote player feature allows two players on different computers to play Pong together in real-time over the network. The architecture follows a client-server model with WebSocket communication for real-time gameplay.

### High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Computer A    â”‚                    â”‚   Computer B    â”‚
â”‚   (Player 1)    â”‚                    â”‚   (Player 2)    â”‚
â”‚                 â”‚                    â”‚                 â”‚
â”‚  Firefox        â”‚                    â”‚  Firefox        â”‚
â”‚  Browser        â”‚                    â”‚  Browser        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                      â”‚
         â”‚ https://192.168.0.155:8443          â”‚
         â”‚ wss://192.168.0.155:8443/ws/remote  â”‚
         â”‚                                      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Nginx (Port 443)â”‚
              â”‚  SSL Termination â”‚
              â”‚  Reverse Proxy   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€ï¿½ï¿½ï¿½
                       â”‚
                       â”œâ”€â”€â”€ Serve SPA (index.html, JS, CSS)
                       â”œâ”€â”€â”€ Proxy /api/* â†’ gateway:3000
                       â””â”€â”€â”€ Proxy /ws/* â†’ gateway:3000 (WebSocket)
                       â”‚
                       â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Gateway Service â”‚
              â”‚  (Port 3000)     â”‚
              â”‚  - WS Proxy      â”‚
              â”‚  - API Router    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”œâ”€â”€â”€ Route REST API calls
                       â”œâ”€â”€â”€ Proxy WebSocket to game-service
                       â””â”€â”€â”€ Handle authentication
                       â”‚
                       â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                             â”‚
         â–¼                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Game Service   â”‚          â”‚  User Service   â”‚
â”‚  (Port 3002)    â”‚          â”‚  (Port 3001)    â”‚
â”‚                 â”‚          â”‚                 â”‚
ï¿½ï¿½ï¿½ - Game logic    â”‚          â”‚ - Auth          â”‚
â”‚ - Room mgmt     â”‚          â”‚ - User data     â”‚
â”‚ - State sync    â”‚          â”‚ - Notifications â”‚
â”‚ - Physics (60Hz)â”‚          â”‚ - Match history â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Database       â”‚
â”‚  (PostgreSQL)   â”‚
â”‚                 â”‚
â”‚ - Users         â”‚
â”‚ - Remote_Match  â”‚
â”‚ - Match history â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## System Architecture Diagram

### Complete Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           FRONTEND (Browser)                              â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  remote.ts      â”‚  â”‚  remote-room.ts  â”‚  â”‚  Babylon.js Renderer   â”‚ â”‚
â”‚  â”‚  (Lobby)        â”‚  â”‚  (Game Room)     â”‚  â”‚  (3D Graphics)         â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                  â”‚  â”‚                        â”‚ â”‚
â”‚  â”‚ - Create room   â”‚  â”‚ - WebSocket mgmt â”‚  â”‚ - Render game state    â”‚ â”‚
â”‚  â”‚ - Join room     â”‚  â”‚ - Input handling â”‚  â”‚ - Update paddles/ball  â”‚ â”‚
â”‚  â”‚ - List rooms    â”‚  â”‚ - State sync     â”‚  â”‚ - Camera control       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚           â”‚                    â”‚                         â”‚              â”‚
â”‚           â”‚ HTTPS              â”‚ WSS                     â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                    â”‚                         â”‚
            â–¼                    â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ï¿½ï¿½â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         NGINX (Reverse Proxy)                             â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ Static Files â”‚  â”‚  API Proxy   â”‚  â”‚  WS Proxy    â”‚                  â”‚
â”‚  â”‚ /            â”‚  â”‚  /api/*      â”‚  â”‚  /ws/*       â”‚                  â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚                  â”‚
â”‚  â”‚ Serve SPA    â”‚  â”‚ â†’ gateway    â”‚  â”‚ â†’ gateway    â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         GATEWAY SERVICE                                   â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  HTTP Router     â”‚  â”‚  WS Proxy        â”‚  â”‚  Auth Middleware       â”‚â”‚
â”‚  â”‚                  â”‚  â”‚                  â”‚  â”‚                        â”‚â”‚
â”‚  â”‚ - Route to       â”‚  â”‚ - Proxy WS to    â”‚  â”‚ - JWT verification     â”‚â”‚
â”‚  â”‚   services       â”‚  â”‚   game-service   â”‚  â”‚ - Session management   â”‚â”‚
â”‚  â”‚ - Load balance   â”‚  â”‚ - Maintain conn  â”‚  â”‚ - Cookie handling      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                       â”‚
                    â–¼                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      GAME SERVICE                â”‚    â”‚      USER SERVICE                â”‚
â”‚                                  â”‚    â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  WebSocket Handler         â”‚ â”‚    â”‚  â”‚  Auth API                  â”‚ â”‚
â”‚  â”‚  (remoteWebSocket.js)      â”‚ â”‚    â”‚  â”‚                            â”‚ â”‚
â”‚  â”‚                            â”‚ â”‚    â”‚  â”‚ - Login/Register           â”‚ â”‚
â”‚  â”‚ - Accept connections       â”‚ â”‚    â”‚  â”‚ - JWT generation           â”‚ â”‚
â”‚  â”‚ - Validate players         â”‚ â”‚    â”‚  â”‚ - User management          â”‚ â”‚
â”‚  â”‚ - Route messages           â”‚ â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚                                  â”‚
â”‚             â”‚                    â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚             â–¼                    â”‚    â”‚  â”‚  Match History API         â”‚ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚  â”‚                            â”‚ â”‚
â”‚  â”‚  Room Manager              â”‚ â”‚    â”‚  â”‚ - Save matches             â”‚ â”‚
â”‚  â”‚  (RoomManager.js)          â”‚ â”‚    â”‚  â”‚ - Query history            â”‚ â”‚
â”‚  â”‚                            â”‚ â”‚    â”‚  â”‚ - Statistics               â”‚ â”‚
â”‚  â”‚ - Create/destroy rooms     â”‚ â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”‚ - Track players            â”‚ â”‚    â”‚                                  â”‚
â”‚  â”‚ - Matchmaking              â”‚ â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚             â”‚                    â”‚
â”‚             â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Game Room                 â”‚ â”‚
â”‚  â”‚  (GameRoom.js)             â”‚ â”‚
â”‚  â”‚                            â”‚ â”‚
â”‚  â”‚ - Player management        â”‚ â”‚
â”‚  â”‚ - Ready state tracking     â”‚ â”‚
â”‚  â”‚ - Countdown management     â”‚ â”‚
â”‚  â”‚ - Game loop (60 FPS)       â”‚ â”‚
â”‚  â”‚ - State broadcasting       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚             â”‚                    â”‚
â”‚             â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Game Logic                â”‚ â”‚
â”‚  â”‚  (gameLogic.js)            â”‚ â”‚
â”‚  â”‚                            â”‚ â”‚
â”‚  â”‚ - Ball physics             â”‚ â”‚
â”‚  â”‚ - Paddle movement          â”‚ â”‚
â”‚  â”‚ - Collision detection      â”‚ â”‚
â”‚  â”‚ - Score tracking           â”‚ â”‚
â”‚  â”‚ - Round management         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚             â”‚                    â”‚
â”‚             â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Database Integration      â”‚ â”‚
â”‚  â”‚  (remoteMatchDB.js)        â”‚ â”‚
â”‚  â”‚                            â”‚ â”‚
â”‚  â”‚ - Create Remote_Match      â”‚ â”‚
â”‚  â”‚ - Update match status      â”‚ â”‚
â”‚  â”‚ - Save final scores        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Game Flow Diagrams

### 1. Room Creation and Joining

```
Player A (Host)                    Server                    Player B (Guest)
     â”‚                               â”‚                              â”‚
     â”‚  1. Navigate to /remote       â”‚                              â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                              â”‚
     â”‚                               â”‚                              â”‚
     â”‚  2. Click "Create Room"       â”‚                              â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                              â”‚
     â”‚                               â”‚                              â”‚
     â”‚  3. POST /api/game/rooms      â”‚                              â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                              â”‚
     â”‚                               â”‚                              â”‚
     â”‚  4. { roomId: "ABC123" }      â”‚                              â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
     â”‚                               â”‚                              â”‚
     â”‚  5. Navigate to               â”‚                              â”‚
     â”‚     /remote/room/ABC123       â”‚                              â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                              â”‚
     â”‚                               â”‚                              â”‚
     â”‚  6. WebSocket Connect         â”‚                              â”‚
     â”‚  wss://.../ws/remote?         ï¿½ï¿½                              â”‚
     â”‚  roomId=ABC123&playerId=...   â”‚                              â”‚
     â”œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•>â”‚                              â”‚
     â”‚                               â”‚                              â”‚
     â”‚  7. { type: 'init',           â”‚                              â”‚
     â”‚      playerNumber: 1,         â”‚                              â”‚
     â”‚      roomInfo: {...} }        â”‚                              â”‚
     â”‚<â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”¤                              â”‚
     â”‚                               â”‚                              â”‚
     â”‚  8. Display waiting room      â”‚                              â”‚
     â”‚     "Waiting for opponent..." â”‚                              â”‚
     â”‚                               â”‚                              â”‚
     â”‚                               â”‚  9. Navigate to /remote      â”‚
     â”‚                               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                               â”‚                              â”‚
     â”‚                               â”‚  10. Click "Join Room"       â”‚
     â”‚                               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     ï¿½ï¿½ï¿½                               â”‚                              â”‚
     â”‚                               â”‚  11. Enter code "ABC123"     â”‚
     â”‚                               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                               â”‚                              â”‚
     â”‚                               â”‚  12. Navigate to             â”‚
     â”‚                               â”‚      /remote/room/ABC123     â”‚
     â”‚                               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                               â”‚                              â”‚
     â”‚                               â”‚  13. WebSocket Connect       â”‚
     â”‚                               â”‚  wss://.../ws/remote?        â”‚
     â”‚                               â”‚  roomId=ABC123&playerId=...  â”‚
     â”‚                               â”‚<â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”¤
     â”‚                               â”‚                              â”‚
     â”‚  14. { type: 'playerJoined',  â”‚  15. { type: 'init',         â”‚
     â”‚       playerId: "...",        â”‚       playerNumber: 2,       â”‚
     â”‚       playerNumber: 2,        â”‚       roomInfo: {...} }      â”‚
     â”‚       playerInfo: {...} }     â”‚                              â”‚
     â”‚<â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•>â”‚
     â”‚                               â”‚                              â”‚
     â”‚  16. Update UI:               â”‚  17. Display waiting room    â”‚
     â”‚      "Player 2 joined!"       â”‚      "You are Player 2"      â”‚
     â”‚      Show Player 2 in list    â”‚      Show Player 1 in list   â”‚
     â”‚                               â”‚                              â”‚
```

### 2. Game Start Sequence

```
Player A                          Server                          Player B
   â”‚                                â”‚                                â”‚
   â”‚  1. Click "Ready" button       â”‚                                â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                â”‚
   â”‚  { type: 'ready' }             â”‚                                â”‚
   â”‚                                â”‚                                â”‚
   â”‚  2. { type: 'playerReady',     â”‚  3. { type: 'playerReady',     â”‚
   â”‚      playerId: "A",            â”‚      playerId: "A",            â”‚
   â”‚      playerNumber: 1 }         â”‚      playerNumber: 1 }         â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                                â”‚                                â”‚
   â”‚  4. Update UI:                 â”‚  5. Update UI:                 â”‚
   â”‚     P1: âœ… READY               â”‚     P1: âœ… READY               â”‚
   â”‚     P2: â³ WAITING             â”‚     P2: â³ WAITING             â”‚
   â”‚                                â”‚                                â”‚
   â”‚                                â”‚  6. Click "Ready" button       â”‚
   â”‚                                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                                â”‚  { type: 'ready' }             â”‚
   â”‚                                â”‚                                â”‚
   â”‚  7. { type: 'playerReady',     â”‚  8. { type: 'playerReady',     â”‚
   â”‚      playerId: "B",            â”‚      playerId: "B",            â”‚
   â”‚      playerNumber: 2 }         â”‚      playerNumber: 2 }         â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                                â”‚                                â”‚
   â”‚  9. Update UI:                 â”‚  10. Update UI:                â”‚
   â”‚     P1: âœ… READY               â”‚      P1: âœ… READY              â”‚
   â”‚     P2: âœ… READY               â”‚      P2: âœ… READY              â”‚
   â”‚                                â”‚                                â”‚
   â”‚  11. Server detects both ready â”‚                                â”‚
   â”‚      Creates Remote_Match in DBâ”‚                                â”‚
   â”‚      Starts countdown          â”‚                                â”‚
   â”‚                                â”‚                                â”‚
   â”‚  12. { type: 'countdown',      â”‚  13. { type: 'countdown',      â”‚
   â”‚       count: 3 }               â”‚       count: 3 }               â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                                â”‚                                â”‚
   â”‚  14. Display: "3"              â”‚  15. Display: "3"              â”‚
   â”‚      Hide waiting room         â”‚      Hide waiting room         â”‚
   â”‚      Show game canvas          â”‚      Show game canvas          â”‚
   â”‚                                â”‚                                â”‚
   â”‚  [Wait 1 second]               â”‚                                â”‚
   â”‚                                â”‚                                â”‚
   â”‚  16. { type: 'countdown',      â”‚  17. { type: 'countdown',      â”‚
   â”‚       count: 2 }               â”‚       count: 2 }               â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                                â”‚                                â”‚
   â”‚  18. Display: "2"              â”‚  19. Display: "2"              â”‚
   â”‚                                â”‚                                â”‚
   â”‚  [Wait 1 second]               â”‚                                â”‚
   â”‚                                â”‚                                â”‚
   â”‚  20. { type: 'countdown',      â”‚  21. { type: 'countdown',      â”‚
   â”‚       count: 1 }               â”‚       count: 1 }               â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ï¿½ï¿½â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                                â”‚                                â”‚
   â”‚  22. Display: "1"              â”‚  23. Display: "1"              â”‚
   â”‚                                â”‚                                â”‚
   â”‚  [Wait 1 second]               â”‚                                â”‚
   â”‚                                â”‚                                â”‚
   â”‚  24. { type: 'countdown',      â”‚  25. { type: 'countdown',      â”‚
   â”‚       count: 0 }               â”‚       count: 0 }               â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                                â”‚                                â”‚
   â”‚  26. Display: "GO!"            â”‚  27. Display: "GO!"            â”‚
   â”‚                                â”‚                                â”‚
   â”‚  [Wait 300ms grace period]     â”‚                                â”‚
   â”‚                                â”‚                                â”‚
   â”‚  28. { type: 'gameStart',      â”‚  29. { type: 'gameStart',      â”‚
   â”‚       gameState: {             â”‚       gameState: {             â”‚
   â”‚         score: {0,0},          â”‚         score: {0,0},          â”‚
   â”‚         ball: {x:0,y:0},       â”‚         ball: {x:0,y:0},       â”‚
   â”‚         paddles: {0,0},        â”‚         paddles: {0,0},        â”‚
   â”‚         tournament: {...}      â”‚         tournament: {...}      â”‚
   â”‚       }}                       â”‚       }}                       â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                                â”‚                                â”‚
   â”‚  30. Initialize Babylon.js     â”‚  31. Initialize Babylon.js     â”‚
   â”‚      Start render loop         â”‚      Start render loop         â”‚
   â”‚      Enable input              â”‚      Enable input              â”‚
   â”‚      Start ping interval       â”‚      Start ping interval       â”‚
   â”‚                                â”‚                                â”‚
   â”‚  32. Game loop starts (60 FPS) â”‚                                â”‚
   â”‚                                â”‚                                â”‚
```

### 3. Game Loop (Real-time Gameplay)

```
Player A                          Server (60 FPS)                   Player B
   â”‚                                    â”‚                                â”‚
   â”‚  1. Press 'W' key                  â”‚                                â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                â”‚
   â”‚  { type: 'paddleMove',             â”‚                                â”‚
   â”‚    direction: 'up' }               â”‚                                â”‚
   â”‚                                    â”‚                                â”‚
   â”‚                                    â”‚  2. Update paddle position     â”‚
   â”‚                                    â”‚     player1 += 15              â”‚
   â”‚                                    â”‚                                â”‚
   â”‚                                    â”‚  3. Move ball                  â”‚
   â”‚                                    â”‚     ball.x += ball.dx * speed  â”‚
   â”‚                                    â”‚     ball.y += ball.dy * speed  â”‚
   â”‚                                    â”‚                                â”‚
   â”‚                                    â”‚  4. Check collisions           â”‚
   â”‚                                    â”‚     - Wall bounces             â”‚
   â”‚                                    â”‚     - Paddle hits              â”‚
   â”‚                                    â”‚     - Score events             â”‚
   â”‚                                    â”‚                                â”‚
   â”‚  5. { type: 'gameState',           â”‚  6. { type: 'gameState',       â”‚
   â”‚      state: {                      â”‚      state: {                  â”‚
   â”‚        ball: {x:10, y:5},          â”‚        ball: {x:10, y:5},      â”‚
   â”‚        paddles: {                  â”‚        paddles: {              â”‚
   â”‚          player1: 15,              â”‚          player1: 15,          â”‚
   â”‚          player2: 0                â”‚          player2: 0            â”‚
   â”‚        },                          â”‚        },                      â”‚
   â”‚        score: {0, 0}               â”‚        score: {0, 0}           â”‚
   â”‚      }}                            â”‚      }}                        â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                                    â”‚                                â”‚
   â”‚  7. Update Babylon scene           â”‚  8. Update Babylon scene       â”‚
   â”‚     - Move paddle1 to y=15         â”‚     - Move paddle1 to y=15     â”‚
   â”‚     - Move ball to (10,5)          â”‚     - Move ball to (10,5)      â”‚
   â”‚     - Render frame                 â”‚     - Render frame             â”‚
   â”‚                                    â”‚                                â”‚
   â”‚                                    â”‚  9. Press 'S' key              â”‚
   â”‚                                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                                    â”‚  { type: 'paddleMove',         â”‚
   â”‚                                    â”‚    direction: 'down' }         â”‚
   â”‚                                    â”‚                                â”‚
   â”‚                                    â”‚  10. Update paddle position    â”‚
   â”‚                                    â”‚      player2 -= 15             â”‚
   â”‚                                    â”‚                                â”‚
   â”‚                                    â”‚  11. Move ball                 â”‚
   â”‚                                    â”‚      Check collisions          â”‚
   â”‚                                    â”‚                                â”‚
   â”‚  12. { type: 'gameState',          â”‚  13. { type: 'gameState',      â”‚
   â”‚       state: {                     â”‚       state: {                 â”‚
   â”‚         ball: {x:12, y:6},         â”‚         ball: {x:12, y:6},     â”‚
   â”‚         paddles: {                 â”‚         paddles: {             â”‚
   â”‚           player1: 15,             â”‚           player1: 15,         â”‚
   â”‚           player2: -15             â”‚           player2: -15         â”‚
   â”‚         },                         â”‚         },                     â”‚
   â”‚         score: {0, 0}              â”‚         score: {0, 0}          â”‚
   â”‚       }}                           â”‚       }}                       â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                                    â”‚                                â”‚
   â”‚  14. Update Babylon scene          â”‚  15. Update Babylon scene      â”‚
   â”‚      - Move paddle2 to y=-15       â”‚      - Move paddle2 to y=-15   â”‚
   â”‚      - Move ball to (12,6)         â”‚      - Move ball to (12,6)     â”‚
   â”‚      - Render frame                â”‚      - Render frame            â”‚
   â”‚                                    â”‚                                â”‚
   â”‚  [This repeats 60 times per second]                                 â”‚
   â”‚                                    â”‚                                â”‚
   â”‚  16. Ball crosses boundary         â”‚                                â”‚
   â”‚      (x > 50)                      â”‚                                â”‚
   â”‚                                    â”‚                                â”‚
   â”‚                                    â”‚  17. Score event!              â”‚
   â”‚                                    â”‚      player1++                 â”‚
   â”‚                                    â”‚      Reset ball                â”‚
   â”‚                                    â”‚                                â”‚
   â”‚  18. { type: 'gameState',          â”‚  19. { type: 'gameState',      â”‚
   â”‚       state: {                     â”‚       state: {                 â”‚
   â”‚         ball: {x:0, y:0},          â”‚         ball: {x:0, y:0},      â”‚
   â”‚         paddles: {15, -15},        â”‚         paddles: {15, -15},    â”‚
   â”‚         score: {1, 0}              â”‚         score: {1, 0}          â”‚
   â”‚       }}                           â”‚       }}                       â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                                    â”‚                                â”‚
   â”‚  20. Update score display          â”‚  21. Update score display      â”‚
   â”‚      P1: 1  P2: 0                  â”‚      P1: 1  P2: 0              â”‚
   â”‚                                    â”‚                                â”‚
   â”‚  22. { type: 'hud',                â”‚  23. { type: 'hud',            â”‚
   â”‚       currentRound: 1,             â”‚       currentRound: 1,         â”‚
   â”‚       roundsWon: {0,0},            â”‚       roundsWon: {0,0},        â”‚
   â”‚       score: {1,0},                â”‚       score: {1,0},            â”‚
   â”‚       scoreLimit: 5 }              â”‚       scoreLimit: 5 }          â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”€â”€â”€â”€â”€â”€â”€â”€ï¿½ï¿½ï¿½â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                                    â”‚                                â”‚
   â”‚  24. Update HUD                    â”‚  25. Update HUD                â”‚
   â”‚      "Round 1/3 | P1 0-P2 0 | to 5"â”‚     "Round 1/3 | P1 0-P2 0 | to 5"
   â”‚                                    â”‚                                â”‚
```

### 4. Round and Match End

```
Player A                          Server                          Player B
   â”‚                                â”‚                                â”‚
   â”‚  [Game continues until         â”‚                                â”‚
   â”‚   score reaches 5]             â”‚                                â”‚
   â”‚                                â”‚                                â”‚
   â”‚  1. Score: P1=5, P2=3          â”‚                                â”‚
   â”‚                                â”‚                                â”‚
   â”‚                                â”‚  2. Round end detected         â”‚
   â”‚                                â”‚     roundsWon.player1++        â”‚
   â”‚                                â”‚     Check if match over        â”‚
   â”‚                                â”‚     (need 2 rounds to win)     â”‚
   â”‚                                â”‚                                ï¿½ï¿½ï¿½
   â”‚                                â”‚  3. Not match over yet         â”‚
   â”‚                                â”‚     Start inter-round countdownâ”‚
   â”‚                                â”‚                                â”‚
   â”‚  4. { type: 'countdown',       â”‚  5. { type: 'countdown',       â”‚
   â”‚      count: 3,                 â”‚      count: 3,                 â”‚
   â”‚      message: "Round 1         â”‚      message: "Round 1         â”‚
   â”‚      complete! Next round      â”‚      complete! Next round      â”‚
   â”‚      in..." }                  â”‚      in..." }                  â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                                â”‚                                â”‚
   â”‚  6. Display message            â”‚  7. Display message            â”‚
   â”‚     Show countdown: 3          â”‚     Show countdown: 3          â”‚
   â”‚                                â”‚                                â”‚
   â”‚  [Countdown 3...2...1...GO!]   â”‚                                â”‚
   â”‚                                â”‚                                â”‚
   â”‚  8. { type: 'roundStart',      â”‚  9. { type: 'roundStart',      â”‚
   â”‚      currentRound: 2,          â”‚      currentRound: 2,          â”‚
   â”‚      roundsWon: {1,0},         â”‚      roundsWon: {1,0},         â”‚
   â”‚      message: "Round 2 -       â”‚      message: "Round 2 -       â”‚
   â”‚      Fight!" }                 â”‚      Fight!" }                 â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                                â”‚                                â”‚
   â”‚  10. Reset scores to 0-0       â”‚  11. Reset scores to 0-0       â”‚
   â”‚      Reset ball/paddles        â”‚      Reset ball/paddles        â”‚
   â”‚      Continue game loop        â”‚      Continue game loop        â”‚
   â”‚                                â”‚                                â”‚
   â”‚  [Round 2 plays out...]        â”‚                                â”‚
   â”‚                                â”‚                                â”‚
   â”‚  12. Score: P1=5, P2=4         â”‚                                â”‚
   â”‚                                â”‚                                â”‚
   â”‚                                â”‚  13. Round end detected        â”‚
   â”‚                                â”‚      roundsWon.player1++       â”‚
   â”‚                                â”‚      Now: roundsWon = {2,0}    â”‚
   â”‚                                â”‚      Match over! (2 rounds won)â”‚
   â”‚                                â”‚                                â”‚
   â”‚                                â”‚  14. Save to database          â”‚
   â”‚                                â”‚      UPDATE Remote_Match       â”‚
   â”‚                                â”‚      SET winner_id = player1   â”‚
   â”‚                                â”‚      SET status = 'completed'  â”‚
   â”‚                                â”‚                                â”‚
   â”‚  15. { type: 'gameEnd',        â”‚  16. { type: 'gameEnd',        â”‚
   â”‚       winner: 1,               â”‚       winner: 1,               â”‚
   â”‚       finalScores: {5,4},      â”‚       finalScores: {5,4},      â”‚
   â”‚       roundsWon: {2,0},        â”‚       roundsWon: {2,0},        â”‚
   â”‚       matchDuration: 180000 }  â”‚       matchDuration: 180000 }  â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                                â”‚                                â”‚
   â”‚  17. Display winner message    â”‚  18. Display winner message    â”‚
   â”‚      ğŸ† YOU WON! ğŸ†           â”‚      Player 1 Won!             â”‚
   â”‚      (green, centered)         â”‚      (yellow, centered)        â”‚
   â”‚                                â”‚                                â”‚
   â”‚  19. Stop game loop            â”‚  20. Stop game loop            â”‚
   â”‚      Clear intervals           â”‚      Clear intervals           â”‚
   â”‚                                â”‚                                â”‚
   â”‚  [Wait 3 seconds]              â”‚                                â”‚
   â”‚                                â”‚                                â”‚
   â”‚  21. Navigate to /remote       â”‚  22. Navigate to /remote       â”‚
   â”‚      (automatic)               â”‚      (automatic)               â”‚
   â”‚                                â”‚                                â”‚
```

---

## Key Components

### 1. Frontend (Browser)

**Location**: `transcendence/frontend/src/pages/remote-room.ts`

**Responsibilities**:
- WebSocket connection management
- Player input handling (W/S keys)
- Game state rendering (Babylon.js)
- UI state management
- Connection error handling

**Key Features**:
- **Connection Guards**: Prevents duplicate connections with `connectionCounter`
- **State Synchronization**: Tracks `connected`, `serverIdReady`, `gameStarted`
- **Input Gating**: 500ms grace period after countdown
- **Visual Freeze**: 300ms delay before ball/paddle movement
- **Ping/Pong**: 3-second interval for latency monitoring

**WebSocket URL Construction**:
```typescript
export const WS_BASE = (() => {
  const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  const host = window.location.host;
  return `${wsProtocol}//${host}/ws`;
})();

// Usage:
const wsUrl = `${WS_BASE}/remote?roomId=${roomId}&playerId=${playerId}&username=${username}`;
// Result: wss://192.168.0.155:8443/ws/remote?roomId=ABC123&playerId=5_1234567890_abc&username=Player1
```

### 2. Nginx Reverse Proxy

**Location**: `transcendence/nginx/nginx.conf`

**Responsibilities**:
- SSL/TLS termination
- Serve static SPA files
- Proxy API requests to gateway
- Proxy WebSocket connections to gateway
- Security headers

**Key Configuration**:
```nginx
# HTTPS Server
server {
    listen 443 ssl http2;
    server_name localhost;

    # SSL Certificates
    ssl_certificate /etc/nginx/ssl/certificate.crt;
    ssl_certificate_key /etc/nginx/ssl/private.key;

    # Serve SPA
    location / {
        root /usr/share/nginx/html;
        try_files $uri $uri/ /index.html;
    }

    # WebSocket Proxy
    location /ws/ {
        proxy_pass http://gateway:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Long timeouts for WebSocket
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
        
        # Disable buffering
        proxy_buffering off;
    }

    # API Proxy
    location /api/ {
        rewrite ^/api/(.*) /$1 break;
        proxy_pass http://gateway:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        # ... other headers
    }
}
```

### 3. Gateway Service

**Location**: `transcendence/services/gateway/src/routes/remote-only.route.ts`

**Responsibilities**:
- Accept WebSocket connections from nginx
- Proxy WebSocket to game-service
- Maintain bidirectional message flow
- Handle connection errors

**Implementation**:
```typescript
fastify.get('/ws/remote', { websocket: true }, async (connection, req) => {
  const clientSocket = connection;
  
  // Extract query parameters
  const url = new URL(req.url, `http://${req.headers.host}`);
  const roomId = url.searchParams.get('roomId');
  const playerId = url.searchParams.get('playerId');
  const username = url.searchParams.get('username');
  
  // Connect to game-service
  const gameServiceUrl = `ws://game-service:3002/ws/remote?roomId=${roomId}&playerId=${playerId}&username=${username}`;
  const backendSocket = new WebSocket(gameServiceUrl);
  
  // Bidirectional message forwarding
  backendSocket.on('open', () => {
    clientSocket.on('message', (message) => {
      backendSocket.send(message);
    });
  });
  
  backendSocket.on('message', (data) => {
    clientSocket.send(data);
  });
  
  // Handle disconnections
  backendSocket.on('close', () => clientSocket.close());
  clientSocket.on('close', () => backendSocket.close());
});
```

### 4. Game Service

**Location**: `transcendence/services/game-service/src/`

**Key Files**:
- `websocket/remoteWebSocket.js` - WebSocket handler
- `room/RoomManager.js` - Room lifecycle management
- `room/GameRoom.js` - Individual game room logic
- `pong/gameLogic.js` - Physics and game rules
- `utils/remoteMatchDB.js` - Database persistence

**Game Room Lifecycle**:

```javascript
// 1. Room Creation
const room = roomManager.createRoom();
// Returns: { roomId: "ABC123" }

// 2. Player Joins
room.addPlayer(playerId, socket, { username, userId });
// Assigns playerNumber (1 or 2)

// 3. Player Ready
room.setPlayerReady(playerId);
// When both ready, starts countdown

// 4. Countdown
room.startCountdown();
// 3...2...1...GO! (1 second intervals)

// 5. Game Start
room.startGame();
// Creates database match
// Starts game loop at 60 FPS

// 6. Game Loop (60 FPS)
room.tick();
// - Move ball
// - Check collisions
// - Update scores
// - Broadcast state

// 7. Round End
// When score reaches 5:
// - Increment roundsWon
// - Check if match over (2 rounds needed)
// - If not, start inter-round countdown

// 8. Match End
room.endGame(winner);
// - Save to database
// - Broadcast winner
// - Clean up resources
```

---

## WebSocket Message Protocol

### Client â†’ Server Messages

#### 1. Paddle Movement
```json
{
  "type": "paddleMove",
  "direction": "up" | "down" | "stop"
}
```
**Frequency**: On keydown/keyup (W/S keys)
**Response**: Included in next `gameState` broadcast

#### 2. Ready Signal
```json
{
  "type": "ready"
}
```
**Frequency**: Once per player when clicking Ready button
**Response**: `playerReady` broadcast to all players

#### 3. Ping (Latency Check)
```json
{
  "type": "ping",
  "ts": 1234567890123
}
```
**Frequency**: Every 3 seconds
**Response**: `pong` with same timestamp

#### 4. Leave Room
```json
{
  "type": "leave"
}
```
**Frequency**: When clicking Leave button
**Response**: Connection closes, `playerDisconnected` to others

### Server â†’ Client Messages

#### 1. Init (Connection Established)
```json
{
  "type": "init",
  "roomId": "ABC123",
  "playerId": "5_1234567890_abc",
  "playerNumber": 1,
  "roomInfo": {
    "roomId": "ABC123",
    "players": [
      {
        "playerId": "5_1234567890_abc",
        "playerNumber": 1,
        "username": "Player1",
        "ready": false
      }
    ],
    "totalPlayers": 1,
    "maxPlayers": 2,
    "isPlaying": false,
    "isFull": false
  }
}
```
**Frequency**: Once per connection, immediately after WebSocket opens

#### 2. Player Joined
```json
{
  "type": "playerJoined",
  "playerId": "6_1234567891_def",
  "playerNumber": 2,
  "playerInfo": {
    "username": "Player2",
    "userId": 6
  },
  "totalPlayers": 2
}
```
**Frequency**: When second player joins room

#### 3. Player Ready
```json
{
  "type": "playerReady",
  "playerId": "5_1234567890_abc",
  "playerNumber": 1
}
```
**Frequency**: When a player clicks Ready

#### 4. Countdown
```json
{
  "type": "countdown",
  "count": 3,
  "message": "Round 1 complete! Next round in..."
}
```
**Frequency**: 
- Initial countdown: 3, 2, 1, 0 (1 second intervals)
- Inter-round countdown: Same pattern between rounds

#### 5. Game Start
```json
{
  "type": "gameStart",
  "gameState": {
    "score": { "player1": 0, "player2": 0 },
    "ball": { "x": 0, "y": 0, "dx": 2, "dy": 2 },
    "paddles": { "player1": 0, "player2": 0 },
    "tournament": {
      "currentRound": 1,
      "maxRounds": 3,
      "scoreLimit": 5,
      "roundsWon": { "player1": 0, "player2": 0 },
      "gameStatus": "playing"
    }
  }
}
```
**Frequency**: Once after countdown completes

#### 6. Game State (Real-time Updates)
```json
{
  "type": "gameState",
  "state": {
    "ball": { "x": 12.5, "y": 8.3 },
    "paddles": { "player1": 15, "player2": -20 },
    "score": { "player1": 2, "player2": 1 },
    "tournament": {
      "currentRound": 1,
      "roundsWon": { "player1": 0, "player2": 0 },
      "gameStatus": "playing"
    }
  },
  "timestamp": 1234567890123
}
```
**Frequency**: 60 times per second during gameplay

#### 7. HUD Update
```json
{
  "type": "hud",
  "currentRound": 1,
  "roundsWon": { "player1": 0, "player2": 0 },
  "score": { "player1": 2, "player2": 1 },
  "scoreLimit": 5,
  "status": "playing"
}
```
**Frequency**: 60 times per second during gameplay

#### 8. Round Start
```json
{
  "type": "roundStart",
  "currentRound": 2,
  "roundsWon": { "player1": 1, "player2": 0 },
  "message": "Round 2 - Fight!"
}
```
**Frequency**: After inter-round countdown completes

#### 9. Game End
```json
{
  "type": "gameEnd",
  "winner": 1,
  "finalScores": { "player1": 5, "player2": 3 },
  "roundsWon": { "player1": 2, "player2": 0 },
  "matchDuration": 180000
}
```
**Frequency**: Once when match ends (player wins 2 rounds)

#### 10. Pong (Latency Response)
```json
{
  "type": "pong",
  "ts": 1234567890123
}
```
**Frequency**: In response to each `ping`

#### 11. Player Disconnected
```json
{
  "type": "playerDisconnected",
  "playerId": "6_1234567891_def",
  "reason": "left"
}
```
**Frequency**: When a player disconnects or leaves

#### 12. Error
```json
{
  "type": "error",
  "message": "Room is full"
}
```
**Frequency**: When an error occurs

---

## Game State Management

### Match Format

- **Best of 3 Rounds**: First player to win 2 rounds wins the match
- **5 Points per Round**: First to 5 points wins the round
- **60 FPS Game Loop**: Smooth physics and rendering

### Game State Structure

```javascript
{
  score: { player1: 0, player2: 0 },           // Current round scores
  ball: { 
    x: 0,                                       // -50 to +50
    y: 0,                                       // -100 to +100
    dx: 2,                                      // X velocity
    dy: 2                                       // Y velocity
  },
  paddles: { 
    player1: 0,                                 // -80 to +80
    player2: 0                                  // -80 to +80
  },
  tournament: {
    currentRound: 1,                            // 1, 2, or 3
    maxRounds: 3,
    scoreLimit: 5,
    roundsWon: { player1: 0, player2: 0 },     // Rounds won (0-2)
    gameStatus: 'playing',                      // 'waiting', 'roundCountdown', 'playing', 'roundEnd', 'gameEnd'
    winner: null,                               // 'player1' or 'player2' when match ends
    lastPointWinner: null                       // 'player1' or 'player2'
  }
}
```

### Physics Constants

```javascript
// Ball
const BALL_MOVE_SPEED = 1.0;      // Base movement speed
const BALL_BOUNCE_SPEED = 1.5;    // Speed after paddle hit
const BALL_RADIUS = 2;             // Collision radius

// Paddles
const PADDLE_SPEED = 15;           // Movement per input
const PADDLE_HEIGHT = 40;          // Collision height
const PADDLE_WIDTH = 2;            // Collision width

// Court
const COURT_WIDTH = 100;           // -50 to +50
const COURT_HEIGHT = 200;          // -100 to +100
const PADDLE_X = 50;               // Paddle X positions (Â±50)
```

### Collision Detection

```javascript
// Wall Collision (Top/Bottom)
if (ball.y >= 96) {
  ball.y = 96;
  ball.dy *= -1;  // Reverse Y velocity
}

// Paddle Collision (Left)
const leftPaddleInnerEdge = -50 + 2;  // -48
if (ball.x - ballRadius <= leftPaddleInnerEdge &&
    ball.dx < 0 &&
    ball.y >= paddle1.y - 20 &&
    ball.y <= paddle1.y + 20) {
  ball.x = leftPaddleInnerEdge + ballRadius;
  bounceOffPaddle(paddle1.y);
}

// Scoring (Ball out of bounds)
if (ball.x < -50) {
  score.player2++;
  resetBall('player1');  // Ball goes to loser
}
```

### Database Persistence

**Table**: `Remote_Match`

```sql
CREATE TABLE Remote_Match (
  id SERIAL PRIMARY KEY,
  player1_id INTEGER REFERENCES "User"(id),
  player2_id INTEGER REFERENCES "User"(id),
  winner_id INTEGER REFERENCES "User"(id),
  player1_score INTEGER DEFAULT 0,
  player2_score INTEGER DEFAULT 0,
  status VARCHAR(20) DEFAULT 'pending',  -- 'pending', 'in_progress', 'completed', 'cancelled'
  started_at TIMESTAMP,
  finished_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW()
);
```

**Lifecycle**:
1. **Create**: When both players ready, before countdown
2. **Start**: After countdown, when game begins
3. **Finish**: When match ends, save winner and final scores

```javascript
// 1. Create match
const matchId = await createRemoteMatch(player1UserId, player2UserId);

// 2. Start match
await startRemoteMatch(matchId);

// 3. Finish match
await finishRemoteMatch(matchId, winnerUserId, finalScore1, finalScore2);
```

---

## Configuration

### Environment Variables

**Location**: `transcendence/.env`

```bash
# Frontend (Browser-side, baked into build)
VITE_API_BASE=/api
VITE_GATEWAY_BASE=/api
VITE_WS_BASE=/ws

# Backend (Docker network)
USER_SERVICE_URL=http://user-service:3001
GAME_SERVICE_URL=http://game-service:3002
GATEWAY_URL=http://gateway:3000

# Ports
GATEWAY_PORT=3000
USER_SERVICE_PORT=3001
GAME_SERVICE_PORT=3002

# Security
JWT_SECRET=your-secret-key-change-in-production

# Database
DATABASE_URL=postgresql://user:password@database:5432/transcendence
```

### Docker Compose

**Location**: `transcendence/docker-compose.yml`

```yaml
services:
  nginx:
    image: nginx:alpine
    ports:
      - "8000:80"
      - "8443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./frontend/dist:/usr/share/nginx/html:ro
    depends_on:
      - gateway

  gateway:
    build: ./services/gateway
    ports:
      - "3000:3000"
    environment:
      - GATEWAY_PORT=3000
      - USER_SERVICE_URL=http://user-service:3001
      - GAME_SERVICE_URL=http://game-service:3002
    depends_on:
      - user-service
      - game-service

  game-service:
    build: ./services/game-service
    ports:
      - "3002:3002"
    environment:
      - GAME_SERVICE_PORT=3002
      - DATABASE_URL=${DATABASE_URL}
    depends_on:
      - database

  user-service:
    build: ./services/user-service
    ports:
      - "3001:3001"
    environment:
      - USER_SERVICE_PORT=3001
      - DATABASE_URL=${DATABASE_URL}
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      - database

  database:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=transcendence
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
```

---

## Testing Guide

### Prerequisites

1. Two computers on the same network
2. Firefox browser on both computers
3. Docker and Docker Compose installed on host
4. SSL certificates generated

### Step-by-Step Testing

#### 1. Build and Deploy

```bash
# On host computer (192.168.0.155)

# Build frontend
cd transcendence/frontend
npm run build

# Start services
cd ..
docker compose up -d

# Verify all services running
docker compose ps
```

#### 2. Test from Host Computer

1. Open Firefox
2. Navigate to `https://192.168.0.155:8443`
3. Accept certificate warning
4. Login or use guest mode
5. Go to "Remote" page
6. Click "Create Room"
7. Note room code (e.g., "ABC123")

#### 3. Test from Remote Computer

1. Open Firefox on second computer
2. Navigate to `https://192.168.0.155:8443`
3. Accept certificate warning
4. Login with different username
5. Go to "Remote" page
6. Click "Join Room"
7. Enter room code
8. Click "Join"

#### 4. Verify Connection

**Check Browser Console (F12)**:
```
âœ… WebSocket OPEN - readyState: 1
ğŸ“¨ INIT message received: {...}
ğŸ“¨ Current gameState.connected: true
ğŸ“¨ Current ws.readyState: 1
```

**Check Network Tab (WS filter)**:
- Status: `101 Switching Protocols`
- Protocol: `wss`
- Messages flowing bidirectionally

#### 5. Play Game

1. Both players click "Ready"
2. Countdown: 3...2...1...GO!
3. Player 1 uses W/S keys
4. Player 2 uses W/S keys
5. Verify smooth gameplay
6. Play until match ends (2 rounds won)

### Expected Behavior

âœ… Both players see each other in waiting room
âœ… Ready button enables when both connected
âœ… Countdown synchronizes
âœ… Game starts simultaneously
âœ… Paddle movements are smooth (< 50ms latency)
âœ… Ball physics are consistent
âœ… Scores update in real-time
âœ… Rounds progress correctly (best of 3)
âœ… Winner message displays
âœ… Match saved to database

---

## Troubleshooting

### Connection Issues

**Problem**: "Connection refused" from remote computer

**Solutions**:
```bash
# Check firewall
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --getglobalstate

# Verify Docker port binding
docker compose ps
# Should show: 0.0.0.0:8443->443/tcp

# Check nginx logs
docker compose logs nginx -f
```

**Problem**: WebSocket connection fails

**Solutions**:
```bash
# Ensure using HTTPS (not HTTP)
# URL should be: https://192.168.0.155:8443

# Check gateway logs
docker compose logs gateway -f

# Check game-service logs
docker compose logs game-service -f

# Verify WebSocket URL in console
# Should be: wss://192.168.0.155:8443/ws/remote...
```

### Gameplay Issues

**Problem**: Game lags or stutters

**Solutions**:
```bash
# Check network latency
ping 192.168.0.155
# Should be < 50ms

# Use wired connection instead of WiFi

# Check CPU usage
docker stats
# No container should use > 80% CPU
```

**Problem**: Players can't see each other

**Solutions**:
```bash
# Check gateway logs for player joins
docker compose logs gateway -f | grep "Player joined"

# Verify different playerIds in browser console
# Each player should have unique ID

# Verify room code matches in URL
```

---

## Summary

The remote player implementation enables cross-computer gameplay through:

1. **Same-origin WebSocket URLs** - Works on any computer accessing the server
2. **HTTPS everywhere** - Secure communication (subject requirement)
3. **Nginx reverse proxy** - Handles SSL, serves SPA, proxies WebSockets
4. **Real-time synchronization** - 60 FPS game loop with WebSocket updates
5. **Relative path configuration** - No hardcoded IPs or hostnames
6. **Best of 3 rounds** - Tournament-style match format
7. **Database persistence** - Match history and statistics

### Architecture Benefits

- âœ… **Scalable** - Multiple concurrent games supported
- âœ… **Secure** - HTTPS and wss:// for all communication
- âœ… **Maintainable** - Clear separation of concerns
- âœ… **Cross-platform** - Works on any computer on the network
- âœ… **Subject-compliant** - Meets all ft_transcendence requirements
- âœ… **Low latency** - 60 FPS game loop, < 50ms typical latency
- âœ… **Robust** - Connection guards, error handling, reconnection support

---

**Last Updated**: January 19, 2025
**Version**: 2.0
**Author**: ft_transcendence team
