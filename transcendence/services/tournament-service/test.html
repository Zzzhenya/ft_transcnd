<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tournament Test UI</title>
  <style>
    body { font-family: sans-serif; background: #222; color: #eee; }
    .container { max-width: 700px; margin: 2em auto; background: #333; padding: 2em; border-radius: 1em; }
    input, button, select { font-size: 1em; margin: 0.2em; }
    .bracket { margin-top: 1em; }
    .match { margin: 0.5em 0; padding: 0.5em; background: #222; border-radius: 0.5em; }
    .winner { color: #0f0; font-weight: bold; }
    .playing { color: #ff0; }
    .finished { color: #0af; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üèÜ Tournament Test UI</h1>
    <div>
      <label>Players (comma separated):</label>
      <input id="players" value="Alice,Bob,Charlie,Daniel">
      <select id="size">
        <option value="4">4 Players</option>
        <option value="8">8 Players</option>
      </select>
      <button id="createBtn">Create Tournament</button>
    </div>
    <div id="tournamentSection" style="display:none;">
      <h2>Tournament <span id="tournamentId"></span></h2>
      <div>
        <strong>Players:</strong>
        <ul id="playerList"></ul>
      </div>
      <div class="bracket" id="bracket"></div>
      <div id="advanceSection"></div>
    </div>
    <div id="log"></div>
  </div>
  <script>
    let tournamentId = null;
    let ws = null;
    let bracket = null;
    let players = [];

    function log(msg) {
      document.getElementById('log').innerHTML = msg + "<br>" + document.getElementById('log').innerHTML;
    }

    document.getElementById('createBtn').onclick = async () => {
      const playerInput = document.getElementById('players').value.trim();
      players = playerInput.split(',').map(s => s.trim()).filter(Boolean);
      const size = parseInt(document.getElementById('size').value, 10);
      if (players.length !== size) {
        alert('Player count must match tournament size!');
        return;
      }
      const res = await fetch('http://localhost:3000/tournaments', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ players })
      });
      const data = await res.json();
      if (!data.id) {
        alert('Failed to create tournament: ' + (data.error || 'Unknown error'));
        return;
      }
      tournamentId = data.id;
      document.getElementById('tournamentId').textContent = tournamentId;
      document.getElementById('tournamentSection').style.display = '';
      connectWS();
      fetchPlayers();
      fetchBracket();
    };

    async function fetchPlayers() {
      const res = await fetch(`http://localhost:3000/tournaments/${tournamentId}/players`);
      const data = await res.json();
      const ul = document.getElementById('playerList');
      ul.innerHTML = '';
      data.players.forEach(p => {
        const li = document.createElement('li');
        li.textContent = p;
        ul.appendChild(li);
      });
    }

    async function fetchBracket() {
      const res = await fetch(`http://localhost:3000/tournaments/${tournamentId}/bracket`);
      const data = await res.json();
      bracket = data.bracket;
      renderBracket();
    }

    function renderBracket() {
      const div = document.getElementById('bracket');
      div.innerHTML = '';
      if (!bracket || !bracket.rounds) return;
      bracket.rounds.forEach((round, i) => {
        const roundDiv = document.createElement('div');
        roundDiv.innerHTML = `<strong>Round ${i+1}</strong>`;
        round.forEach(match => {
          const m = document.createElement('div');
          m.className = 'match';
          m.innerHTML = `
            <span>${match.player1 || 'TBD'}</span>
            <span> vs </span>
            <span>${match.player2 || 'TBD'}</span>
            <span class="${match.status}">${match.status === 'finished' ? 'üèÜ' : match.status === 'playing' ? 'üéÆ' : ''}</span>
            ${match.winner ? `<span class="winner">Winner: ${match.winner}</span>` : ''}
          `;
          roundDiv.appendChild(m);
        });
        div.appendChild(roundDiv);
      });
      renderAdvance();
    }

    function renderAdvance() {
      const div = document.getElementById('advanceSection');
      div.innerHTML = '';
      if (!bracket || !bracket.rounds) return;
      // Find first match that is not finished and has both players
      for (const round of bracket.rounds) {
        for (const match of round) {
          if (match.status !== 'finished' && match.player1 && match.player2) {
            const btn1 = document.createElement('button');
            btn1.textContent = `Set Winner: ${match.player1}`;
            btn1.onclick = () => advance(match.matchId, match.player1);
            const btn2 = document.createElement('button');
            btn2.textContent = `Set Winner: ${match.player2}`;
            btn2.onclick = () => advance(match.matchId, match.player2);
            div.appendChild(document.createTextNode(`Advance match ${match.matchId}: `));
            div.appendChild(btn1);
            div.appendChild(btn2);
            return;
          }
        }
      }
      div.innerHTML = '<b>Tournament finished!</b>';
    }

    function connectWS() {
      if (ws) ws.close();
      ws = new WebSocket(`ws://localhost:3000/ws/tournament/${tournamentId}`);
      ws.onopen = () => log('WebSocket connected');
      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        if (msg.type === 'tournament.update') {
          bracket = msg.data.bracket;
          renderBracket();
          fetchPlayers();
        }
      };
      ws.onclose = () => log('WebSocket closed');
      ws.onerror = (e) => log('WebSocket error');
    }

    async function advance(matchId, winner) {
      await fetch(`http://localhost:3000/tournaments/${tournamentId}/advance`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ matchId, winner })
      });
      // Updates will come via WebSocket
    }
  </script>
</body>
</html>