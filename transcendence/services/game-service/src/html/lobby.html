<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pong Multiplayer Lobby</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a2e;
            color: #eee;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #00d4aa;
            margin-bottom: 10px;
        }
        
        .user-section {
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .user-section h2 {
            color: #00d4aa;
            margin-top: 0;
        }
        
        .user-input {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .user-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 5px;
            background: #0f1419;
            color: #eee;
        }
        
        .user-input button {
            padding: 10px 20px;
            background: #00d4aa;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .user-input button:hover {
            background: #00b894;
        }
        
        .user-info {
            background: #0f1419;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .actions-section {
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .actions-section h2 {
            color: #00d4aa;
            margin-top: 0;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .action-buttons button {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .btn-create {
            background: #00d4aa;
            color: white;
        }
        
        .btn-create:hover {
            background: #00b894;
        }
        
        .btn-refresh {
            background: #74b9ff;
            color: white;
        }
        
        .btn-refresh:hover {
            background: #0984e3;
        }
        
        .games-section {
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .games-section h2 {
            color: #00d4aa;
            margin-top: 0;
        }
        
        .games-list {
            display: grid;
            gap: 15px;
        }
        
        .game-card {
            background: #0f1419;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #333;
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .game-id {
            font-size: 18px;
            font-weight: bold;
            color: #00d4aa;
        }
        
        .game-status {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-waiting {
            background: #fdcb6e;
            color: #2d3436;
        }
        
        .status-ready {
            background: #00d4aa;
            color: white;
        }
        
        .status-active {
            background: #e17055;
            color: white;
        }
        
        .game-players {
            margin-bottom: 15px;
        }
        
        .player {
            margin-bottom: 5px;
        }
        
        .player-name {
            font-weight: bold;
            color: #74b9ff;
        }
        
        .game-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-join {
            background: #00d4aa;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .btn-join:hover {
            background: #00b894;
        }
        
        .btn-join:disabled {
            background: #636e72;
            cursor: not-allowed;
        }
        
        .btn-watch {
            background: #74b9ff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .btn-watch:hover {
            background: #0984e3;
        }
        
        .game-section {
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: none;
        }
        
        .game-section.active {
            display: block;
        }
        
        .game-section h2 {
            color: #00d4aa;
            margin-top: 0;
        }
        
        .game-info {
            background: #0f1419;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .ready-section {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .btn-ready {
            background: #00d4aa;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
        }
        
        .btn-ready:hover {
            background: #00b894;
        }
        
        .btn-ready:disabled {
            background: #636e72;
            cursor: not-allowed;
        }
        
        .countdown {
            text-align: center;
            font-size: 48px;
            font-weight: bold;
            color: #e17055;
            margin: 20px 0;
        }
        
        .game-canvas {
            background: #000;
            border: 2px solid #00d4aa;
            margin: 0 auto;
            display: block;
        }
        
        .controls {
            text-align: center;
            margin-top: 20px;
            color: #74b9ff;
        }
        
        .controls p {
            margin: 5px 0;
        }
        
        .back-button {
            background: #636e72;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        .back-button:hover {
            background: #2d3436;
        }
        
        .messages {
            background: #0f1419;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .message {
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }
        
        .message:last-child {
            border-bottom: none;
        }
        
        .message.info {
            color: #74b9ff;
        }
        
        .message.success {
            color: #00d4aa;
        }
        
        .message.error {
            color: #e17055;
        }
        
        .message.warning {
            color: #fdcb6e;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üèì Pong Multiplayer Lobby</h1>
        <p>Create or join games to play against other players</p>
    </div>

    <!-- User Registration Section -->
    <div class="user-section">
        <h2>üë§ Player Registration</h2>
        <div class="user-input">
            <input type="number" id="userId" placeholder="Your User ID (e.g., 123)" min="1">
            <input type="text" id="userName" placeholder="Your Name (e.g., Player1)" maxlength="20">
            <button onclick="registerUser()">Register</button>
        </div>
        <div id="userInfo" class="user-info" style="display: none;">
            <strong>Registered as:</strong> <span id="currentUser"></span>
        </div>
    </div>

    <!-- Actions Section -->
    <div class="actions-section">
        <h2>üéÆ Game Actions</h2>
        <div class="action-buttons">
            <button class="btn-create" onclick="createGame()" disabled id="createBtn">Create New Game</button>
            <button class="btn-refresh" onclick="refreshGames()">Refresh Games</button>
        </div>
    </div>

    <!-- Games List Section -->
    <div class="games-section">
        <h2>üéØ Available Games</h2>
        <div id="gamesList" class="games-list">
            <p>Click "Refresh Games" to see available games</p>
        </div>
    </div>

    <!-- Game Session Section -->
    <div id="gameSection" class="game-section">
        <button class="back-button" onclick="backToLobby()">‚Üê Back to Lobby</button>
        <h2 id="gameTitle">Game Session</h2>
        
        <div id="gameInfo" class="game-info">
            <p><strong>Game ID:</strong> <span id="currentGameId">-</span></p>
            <p><strong>Player 1:</strong> <span id="currentPlayer1">-</span></p>
            <p><strong>Player 2:</strong> <span id="currentPlayer2">-</span></p>
            <p><strong>Status:</strong> <span id="currentGameStatus">-</span></p>
            <p><strong>Round:</strong> <span id="currentRound">-</span> of <span id="maxRounds">-</span></p>
            <p><strong>Rounds Won:</strong> P1: <span id="roundsWonP1">0</span> | P2: <span id="roundsWonP2">0</span></p>
        </div>

        <div id="readySection" class="ready-section">
            <button id="readyBtn" class="btn-ready" onclick="playerReady()">Ready Up!</button>
            <p id="readyStatus">Waiting for players to ready up...</p>
        </div>

        <div id="countdownSection" style="display: none;">
            <div class="countdown" id="countdown">3</div>
        </div>

        <div id="gameCanvas" style="display: none;">
            <canvas id="pongCanvas" class="game-canvas" width="800" height="400"></canvas>
            <div class="controls">
                <p><strong>Controls:</strong></p>
                <p>Player 1: W (Up) / S (Down)</p>
                <p>Player 2: ‚Üë (Up) / ‚Üì (Down)</p>
            </div>
        </div>

        <div id="messages" class="messages"></div>
    </div>

    <script>
        // Global state
        let currentUser = { id: null, name: null };
        let currentGameId = null;
        let ws = null;
        let gameCanvas = null;
        let gameCtx = null;
        let gameState = null;
        let currentGameInfo = { player1_name: null, player2_name: null };

        // Initialize
        function init() {
            gameCanvas = document.getElementById('pongCanvas');
            gameCtx = gameCanvas.getContext('2d');
            refreshGames();
        }

        // User registration
        function registerUser() {
            const userId = document.getElementById('userId').value;
            const userName = document.getElementById('userName').value;

            if (!userId || !userName) {
                alert('Please enter both User ID and Name');
                return;
            }

            currentUser.id = parseInt(userId);
            currentUser.name = userName.trim();

            document.getElementById('currentUser').textContent = `${currentUser.name} (ID: ${currentUser.id})`;
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('createBtn').disabled = false;

            addMessage(`Registered as ${currentUser.name}`, 'success');
        }

        // Create new game
        async function createGame() {
            if (!currentUser.id) {
                alert('Please register first');
                return;
            }

            try {
                const response = await fetch('http://localhost:3002/ws/pong/game', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        player1_id: currentUser.id,
                        player1_name: currentUser.name
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    addMessage(`Game created! Game ID: ${result.id}`, 'success');
                    refreshGames();
                } else {
                    addMessage(`Error creating game: ${result.error}`, 'error');
                }
            } catch (error) {
                addMessage(`Error creating game: ${error.message}`, 'error');
            }
        }

        // Refresh games list
        async function refreshGames() {
            try {
                const response = await fetch('http://localhost:3002/ws/pong/game');
                const result = await response.json();

                const gamesList = document.getElementById('gamesList');
                gamesList.innerHTML = '';

                if (result.games && result.games.length > 0) {
                    result.games.forEach(game => {
                        const gameCard = createGameCard(game);
                        gamesList.appendChild(gameCard);
                    });
                } else {
                    gamesList.innerHTML = '<p>No games available. Create one to get started!</p>';
                }
            } catch (error) {
                addMessage(`Error fetching games: ${error.message}`, 'error');
            }
        }

        // Create game card HTML
        function createGameCard(game) {
            const card = document.createElement('div');
            card.className = 'game-card';

            const statusClass = `status-${game.status.replace('_', '-')}`;
            
            card.innerHTML = `
                <div class="game-header">
                    <div class="game-id">Game #${game.id}</div>
                    <div class="game-status ${statusClass}">${game.status.replace('_', ' ').toUpperCase()}</div>
                </div>
                <div class="game-players">
                    <div class="player">Player 1: <span class="player-name">${game.player1_name}</span></div>
                    <div class="player">Player 2: <span class="player-name">${game.player2_name || 'Waiting...'}</span></div>
                </div>
                <div class="game-actions">
                    ${game.status === 'waiting_for_player' && currentUser.id !== game.player1_id ? 
                        `<button class="btn-join" onclick="joinGame(${game.id})">Join Game</button>` : ''}
                    ${game.status === 'ready' && (currentUser.id === game.player1_id || currentUser.id === game.player2_id) ? 
                        `<button class="btn-join" onclick="enterGame(${game.id})">Enter Game</button>` : ''}
                    ${game.status === 'active' ? 
                        `<button class="btn-watch" onclick="watchGame(${game.id})">Watch Game</button>` : ''}
                </div>
            `;

            return card;
        }

        // Join existing game
        async function joinGame(gameId) {
            if (!currentUser.id) {
                alert('Please register first');
                return;
            }

            try {
                const response = await fetch(`http://localhost:3002/ws/pong/game/${gameId}/join`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        player2_id: currentUser.id,
                        player2_name: currentUser.name
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    addMessage(`Joined game ${gameId}!`, 'success');
                    enterGame(gameId);
                } else {
                    addMessage(`Error joining game: ${result.error}`, 'error');
                }
            } catch (error) {
                addMessage(`Error joining game: ${error.message}`, 'error');
            }
        }

        // Enter game session
        function enterGame(gameId) {
            currentGameId = gameId;
            document.querySelector('.games-section').style.display = 'none';
            document.querySelector('.actions-section').style.display = 'none';
            document.getElementById('gameSection').classList.add('active');

            connectWebSocket(gameId);
        }

        // Watch game
        function watchGame(gameId) {
            enterGame(gameId);
            document.getElementById('readySection').style.display = 'none';
        }

        // Connect to WebSocket
        function connectWebSocket(gameId) {
            const wsUrl = `ws://localhost:3002/ws/pong/game-ws/${gameId}`;
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                addMessage('Connected to game!', 'success');
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleWebSocketMessage(message);
            };

            ws.onclose = () => {
                addMessage('Disconnected from game', 'warning');
            };

            ws.onerror = (error) => {
                addMessage(`WebSocket error: ${error}`, 'error');
            };
        }

        // Handle WebSocket messages
        function handleWebSocketMessage(message) {
            switch (message.type) {
                case 'STATE_UPDATE':
                    updateGameInfo(message);
                    // Store current game info for canvas display
                    currentGameInfo = {
                        player1_name: message.player1_name,
                        player2_name: message.player2_name
                    };
                    if (message.gameState) {
                        gameState = message.gameState;
                        drawGame();
                    }
                    break;

                case 'PLAYER_JOINED':
                    addMessage(message.message, 'success');
                    break;

                case 'PLAYER_READY_UPDATE':
                    addMessage(message.message, 'info');
                    updateReadyStatus(message.playersReady);
                    break;

                case 'GAME_START_COUNTDOWN':
                    showCountdown(message.countdown);
                    addMessage(message.message, 'warning');
                    break;

                case 'GAME_STARTED':
                    hideCountdown();
                    showGameCanvas();
                    addMessage(message.message, 'success');
                    break;

                case 'ERROR':
                    addMessage(message.message, 'error');
                    break;

                default:
                    console.log('Unknown message type:', message.type);
            }
        }

        // Update game info display
        function updateGameInfo(message) {
            document.getElementById('currentGameId').textContent = message.gameId;
            document.getElementById('currentPlayer1').textContent = message.player1_name;
            document.getElementById('currentPlayer2').textContent = message.player2_name || 'Waiting...';
            document.getElementById('currentGameStatus').textContent = message.status;
            
            // Update round information if available
            if (message.gameState && message.gameState.tournament) {
                const tournament = message.gameState.tournament;
                document.getElementById('currentRound').textContent = tournament.currentRound || 1;
                document.getElementById('maxRounds').textContent = tournament.maxRounds || 3;
                document.getElementById('roundsWonP1').textContent = tournament.roundsWon ? tournament.roundsWon.player1 : 0;
                document.getElementById('roundsWonP2').textContent = tournament.roundsWon ? tournament.roundsWon.player2 : 0;
            }
        }

        // Player ready
        function playerReady() {
            if (!ws || !currentUser.id) return;

            ws.send(JSON.stringify({
                type: 'PLAYER_READY',
                player_id: currentUser.id
            }));

            document.getElementById('readyBtn').disabled = true;
            document.getElementById('readyBtn').textContent = 'Ready!';
        }

        // Update ready status
        function updateReadyStatus(playersReady) {
            const status = document.getElementById('readyStatus');
            const ready1 = playersReady.player1 ? '‚úÖ' : '‚è≥';
            const ready2 = playersReady.player2 ? '‚úÖ' : '‚è≥';
            status.textContent = `Player 1: ${ready1} | Player 2: ${ready2}`;
        }

        // Show countdown
        function showCountdown(count) {
            document.getElementById('readySection').style.display = 'none';
            document.getElementById('countdownSection').style.display = 'block';
            document.getElementById('countdown').textContent = count;
        }

        // Hide countdown
        function hideCountdown() {
            document.getElementById('countdownSection').style.display = 'none';
        }

        // Show game canvas
        function showGameCanvas() {
            document.getElementById('gameCanvas').style.display = 'block';
        }

        // Draw game - FIXED for current paddle format
        function drawGame() {
            if (!gameState || !gameCtx) return;

            // Clear canvas
            gameCtx.fillStyle = '#000';
            gameCtx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);

            // Draw center line
            gameCtx.strokeStyle = '#fff';
            gameCtx.setLineDash([5, 15]);
            gameCtx.beginPath();
            gameCtx.moveTo(gameCanvas.width / 2, 0);
            gameCtx.lineTo(gameCanvas.width / 2, gameCanvas.height);
            gameCtx.stroke();
            gameCtx.setLineDash([]);

            // Draw paddles
            gameCtx.fillStyle = '#00d4aa';
            
            // Convert game coordinates to canvas coordinates
            const scaleX = gameCanvas.width / 100;  // Game is -50 to +50
            const scaleY = gameCanvas.height / 200; // Game is -100 to +100
            
            // Paddles positions: gameState.paddles contains Y positions only
            // Player 1 paddle at left side (x = -50)
            const paddle1X = (-50 + 50) * scaleX;  // Convert -50 to canvas coordinate
            const paddle1Y = (gameState.paddles.player1 + 100) * scaleY;
            
            // Player 2 paddle at right side (x = 50) 
            const paddle2X = (50 + 50) * scaleX;   // Convert 50 to canvas coordinate
            const paddle2Y = (gameState.paddles.player2 + 100) * scaleY;
            
            // Draw paddles (10px wide, 60px tall)
            gameCtx.fillRect(paddle1X - 5, paddle1Y - 30, 10, 60);
            gameCtx.fillRect(paddle2X - 5, paddle2Y - 30, 10, 60);

            // Draw ball
            gameCtx.fillStyle = '#fff';
            const ballX = (gameState.ball.x + 50) * scaleX;
            const ballY = (gameState.ball.y + 100) * scaleY;
            gameCtx.beginPath();
            gameCtx.arc(ballX, ballY, 8, 0, Math.PI * 2);
            gameCtx.fill();

            // Draw score and player info
            gameCtx.fillStyle = '#fff';
            gameCtx.font = '24px Arial';
            gameCtx.textAlign = 'center';
            gameCtx.fillText(`${gameState.score.player1} - ${gameState.score.player2}`, gameCanvas.width / 2, 30);
            
            // Draw player names
            gameCtx.font = '16px Arial';
            gameCtx.textAlign = 'left';
            gameCtx.fillStyle = '#00d4aa';
            gameCtx.fillText(`Player 1: ${currentGameInfo.player1_name || 'Player 1'}`, 20, 60);
            gameCtx.textAlign = 'right';
            gameCtx.fillText(`Player 2: ${currentGameInfo.player2_name || 'Player 2'}`, gameCanvas.width - 20, 60);
            
            // Draw round information if available
            if (gameState.tournament) {
                gameCtx.textAlign = 'center';
                gameCtx.fillStyle = '#74b9ff';
                gameCtx.font = '14px Arial';
                gameCtx.fillText(`Round ${gameState.tournament.currentRound} of ${gameState.tournament.maxRounds}`, gameCanvas.width / 2, 380);
                
                // Draw rounds won
                gameCtx.textAlign = 'left';
                gameCtx.fillStyle = '#fdcb6e';
                gameCtx.fillText(`Rounds Won: ${gameState.tournament.roundsWon.player1}`, 20, 380);
                gameCtx.textAlign = 'right';
                gameCtx.fillText(`Rounds Won: ${gameState.tournament.roundsWon.player2}`, gameCanvas.width - 20, 380);
            }
        }

        // Keyboard controls
        document.addEventListener('keydown', (event) => {
            if (!ws) return;

            let player = null;
            let direction = null;

            if (event.key === 'w' || event.key === 'W') {
                player = 'player1';
                direction = 'down';  // W key moves paddle up on screen, but backend expects 'down' for positive Y
            } else if (event.key === 's' || event.key === 'S') {
                player = 'player1';
                direction = 'up';    // S key moves paddle down on screen, but backend expects 'up' for negative Y
            } else if (event.key === 'ArrowUp') {
                player = 'player2';
                direction = 'down';  // Arrow up moves paddle up on screen, but backend expects 'down' for positive Y
            } else if (event.key === 'ArrowDown') {
                player = 'player2';
                direction = 'up';    // Arrow down moves paddle down on screen, but backend expects 'up' for negative Y
            }

            if (player && direction) {
                event.preventDefault();
                console.log(`Moving ${player} paddle ${direction}`); // Debug log
                ws.send(JSON.stringify({
                    type: 'MOVE_PADDLE',
                    player: player,
                    direction: direction
                }));
            }
        });

        // Back to lobby
        function backToLobby() {
            if (ws) {
                ws.close();
                ws = null;
            }
            
            currentGameId = null;
            document.querySelector('.games-section').style.display = 'block';
            document.querySelector('.actions-section').style.display = 'block';
            document.getElementById('gameSection').classList.remove('active');
            document.getElementById('readySection').style.display = 'block';
            document.getElementById('countdownSection').style.display = 'none';
            document.getElementById('gameCanvas').style.display = 'none';
            document.getElementById('readyBtn').disabled = false;
            document.getElementById('readyBtn').textContent = 'Ready Up!';
            
            refreshGames();
        }

        // Add message to chat
        function addMessage(text, type = 'info') {
            const messages = document.getElementById('messages');
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
            messages.appendChild(message);
            messages.scrollTop = messages.scrollHeight;
        }

        // Initialize when page loads
        window.onload = init;
    </script>
</body>
</html>