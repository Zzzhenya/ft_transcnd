<!-- transcendence/services/game-service/test-remote-game.html -->
<!DOCTYPE html>
<html>

<head>
	<title>üéÆ Remote Pong - Full Game</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background: #1a1a2e;
			color: white;
			display: flex;
			flex-direction: column;
			align-items: center;
			min-height: 100vh;
			padding: 20px;
			overflow-x: hidden;
			/* Prevenir scroll horizontal */
		}

		h1 {
			margin: 20px 0;
			color: #00d9ff;
			text-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
		}

		.game-container {
			background: #16213e;
			border-radius: 12px;
			padding: 20px;
			box-shadow: 0 0 30px rgba(0, 217, 255, 0.3);
			margin: 20px 0;
		}

		#gameCanvas {
			background: #0f0f23;
			border: 3px solid #00d9ff;
			border-radius: 8px;
			box-shadow: 0 0 20px rgba(0, 217, 255, 0.5);
			display: block;
		}

		.info-panel {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
			gap: 15px;
			max-width: 800px;
			width: 100%;
			margin: 20px 0;
		}

		.info-card {
			background: #16213e;
			padding: 15px;
			border-radius: 8px;
			text-align: center;
			border: 2px solid #00d9ff;
		}

		.info-card .label {
			font-size: 12px;
			color: #aaa;
			margin-bottom: 5px;
		}

		.info-card .value {
			font-size: 24px;
			font-weight: bold;
			color: #00d9ff;
		}

		.controls {
			background: #16213e;
			padding: 20px;
			border-radius: 8px;
			max-width: 800px;
			width: 100%;
			margin: 20px 0;
		}

		.input-group {
			margin: 10px 0;
		}

		label {
			display: block;
			margin-bottom: 5px;
			color: #00d9ff;
		}

		input {
			width: 100%;
			padding: 10px;
			border: 2px solid #00d9ff;
			border-radius: 6px;
			background: #0f0f23;
			color: white;
			font-size: 16px;
		}

		.button-group {
			display: flex;
			gap: 10px;
			flex-wrap: wrap;
			margin: 15px 0;
		}

		button {
			flex: 1;
			padding: 12px 20px;
			border: none;
			border-radius: 6px;
			font-size: 16px;
			font-weight: bold;
			cursor: pointer;
			transition: all 0.3s;
			min-width: 120px;
		}

		button:hover {
			transform: translateY(-2px);
			box-shadow: 0 5px 15px rgba(0, 217, 255, 0.4);
		}

		button:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}

		.btn-primary {
			background: #00d9ff;
			color: #0f0f23;
		}

		.btn-success {
			background: #00ff88;
			color: #0f0f23;
		}

		.btn-danger {
			background: #ff0055;
			color: white;
		}

		.status {
			padding: 15px;
			border-radius: 8px;
			text-align: center;
			font-weight: bold;
			margin: 10px 0;
		}

		.connected {
			background: #00ff88;
			color: #0f0f23;
		}

		.disconnected {
			background: #ff0055;
			color: white;
		}

		#log {
			background: #0f0f23;
			color: #00ff88;
			padding: 15px;
			border-radius: 8px;
			height: 200px;
			overflow-y: auto;
			font-family: monospace;
			font-size: 12px;
			border: 2px solid #00d9ff;
		}

		.score-display {
			font-size: 48px;
			text-align: center;
			margin: 20px 0;
			color: #00d9ff;
			text-shadow: 0 0 20px rgba(0, 217, 255, 0.8);
		}

		.countdown-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.8);
			display: none;
			justify-content: center;
			align-items: center;
			z-index: 1000;
		}

		.countdown-number {
			font-size: 200px;
			color: #00d9ff;
			text-shadow: 0 0 50px rgba(0, 217, 255, 1);
			animation: pulse 0.5s ease-in-out;
		}

		@keyframes pulse {

			0%,
			100% {
				transform: scale(1);
			}

			50% {
				transform: scale(1.2);
			}
		}

		.game-over-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.9);
			display: none;
			justify-content: center;
			align-items: center;
			flex-direction: column;
			z-index: 1000;
		}

		.game-over-text {
			font-size: 80px;
			color: #00d9ff;
			text-shadow: 0 0 30px rgba(0, 217, 255, 1);
			margin: 20px 0;
		}

		.winner-text {
			font-size: 60px;
			color: #00ff88;
			margin: 20px 0;
		}
	</style>
</head>

<body>
	<h1>üéÆ REMOTE PONG</h1>

	<!-- Status -->
	<div id="status" class="status disconnected">‚ö´ Disconnected</div>

	<!-- Info Panel -->
	<div class="info-panel">
		<div class="info-card">
			<div class="label">Room ID</div>
			<div class="value" id="displayRoomId">-</div>
		</div>
		<div class="info-card">
			<div class="label">You are</div>
			<div class="value" id="displayPlayerNum">-</div>
		</div>
		<div class="info-card">
			<div class="label">Players</div>
			<div class="value" id="displayPlayers">0/2</div>
		</div>
		<div class="info-card">
			<div class="label">Ping</div>
			<div class="value" id="displayLatency">-</div>
		</div>
	</div>

	<!-- Score -->
	<div class="score-display" id="scoreDisplay">0 - 0</div>

	<!-- Game Canvas -->
	<div class="game-container">
		<canvas id="gameCanvas" width="800" height="600"></canvas>
	</div>

	<!-- Controls -->
	<div class="controls">
		<div class="input-group">
			<label>üÜî Room ID:</label>
			<input type="text" id="roomId" placeholder="ABC123" maxlength="6">
		</div>

		<div class="input-group">
			<label>üë§ Player ID:</label>
			<input type="text" id="playerId" placeholder="player1" value="player1">
		</div>

		<div class="input-group">
			<label>‚úèÔ∏è Username:</label>
			<input type="text" id="username" placeholder="Player" value="Player1">
		</div>

		<div class="button-group">
			<button class="btn-primary" onclick="createRoom()">üÜï Create Room</button>
			<button class="btn-success" onclick="connect()">üîå Connect</button>
			<button class="btn-danger" onclick="disconnect()">‚èπÔ∏è Disconnect</button>
		</div>

		<div class="button-group">
			<button class="btn-success" onclick="sendReady()" id="readyBtn">‚úÖ Ready</button>
		</div>

		<div style="margin-top: 20px; padding: 10px; background: #0f0f23; border-radius: 6px;">
			<strong>üéÆ Controls:</strong> Use ‚¨ÜÔ∏è Arrow Up / ‚¨áÔ∏è Arrow Down to move your paddle
		</div>
	</div>

	<!-- Log -->
	<div class="controls">
		<h3>Console Log</h3>
		<div id="log"></div>
	</div>

	<!-- Countdown Overlay -->
	<div class="countdown-overlay" id="countdownOverlay">
		<div class="countdown-number" id="countdownNumber">3</div>
	</div>

	<!-- Game Over Overlay -->
	<div class="game-over-overlay" id="gameOverOverlay">
		<div class="game-over-text">GAME OVER</div>
		<div class="winner-text" id="winnerText"></div>
	</div>

	<script>
		// ========================================
		// CANVAS SETUP
		// ========================================

		const canvas = document.getElementById('gameCanvas');
		const ctx = canvas.getContext('2d');

		let ws = null;
		let myPlayerNumber = null;
		let gameState = null;
		let latencyInterval = null;

		// ========================================
		// RENDERING
		// ========================================

	function render() {
		// Clear canvas
		ctx.fillStyle = '#0f0f23';
		ctx.fillRect(0, 0, canvas.width, canvas.height);

		if (!gameState) {
			ctx.fillStyle = '#00d9ff';
			ctx.font = '30px Arial';
			ctx.textAlign = 'center';
			ctx.fillText('Waiting for players...', canvas.width / 2, canvas.height / 2);
			return;
		}

		// Draw center line
		ctx.strokeStyle = '#00d9ff';
		ctx.lineWidth = 2;
		ctx.setLineDash([10, 10]);
		ctx.beginPath();
		ctx.moveTo(canvas.width / 2, 0);
		ctx.lineTo(canvas.width / 2, canvas.height);
		ctx.stroke();
		ctx.setLineDash([]);

		// CORRECCI√ìN: Conversi√≥n de coordenadas
		const gameWidth = 100;   // X va de -50 a +50
		const gameHeight = 200;  // Y va de -100 a +100

		const toCanvasX = (x) => ((x + 50) / gameWidth) * canvas.width;
		const toCanvasY = (y) => ((100 - y) / gameHeight) * canvas.height;

		// Draw paddles
		const paddleWidth = 10;
		const paddleHeight = 60;

		// Player 1 paddle (left) at x=-50
		if (myPlayerNumber === 1) {
			ctx.fillStyle = '#00ff88';
			ctx.shadowColor = '#00ff88';
			ctx.shadowBlur = 20;
		} else {
			ctx.fillStyle = '#ffffff';
			ctx.shadowBlur = 0;
		}

		const p1X = toCanvasX(-50);  // Paddle est√° en x=-50
		const p1Y = toCanvasY(gameState.paddles.player1);

		ctx.fillRect(
			p1X - paddleWidth / 2,  // Centrar paddle
			p1Y - paddleHeight / 2,
			paddleWidth,
			paddleHeight
		);

		// Player 2 paddle (right) at x=+50
		if (myPlayerNumber === 2) {
			ctx.fillStyle = '#00ff88';
			ctx.shadowColor = '#00ff88';
			ctx.shadowBlur = 20;
		} else {
			ctx.fillStyle = '#ffffff';
			ctx.shadowBlur = 0;
		}

		const p2X = toCanvasX(50);  // Paddle est√° en x=+50
		const p2Y = toCanvasY(gameState.paddles.player2);

		ctx.fillRect(
			p2X - paddleWidth / 2,  // Centrar paddle
			p2Y - paddleHeight / 2,
			paddleWidth,
			paddleHeight
		);

		// Draw ball
		ctx.fillStyle = '#00d9ff';
		ctx.shadowColor = '#00d9ff';
		ctx.shadowBlur = 20;

		const ballX = toCanvasX(gameState.ball.x);
		const ballY = toCanvasY(gameState.ball.y);
		const ballRadius = 8;

		ctx.beginPath();
		ctx.arc(ballX, ballY, ballRadius, 0, Math.PI * 2);
		ctx.fill();

		ctx.shadowBlur = 0;

		// Update score display
		document.getElementById('scoreDisplay').textContent =
			`${gameState.score.player1} - ${gameState.score.player2}`;

		// DEBUG: Mostrar posiciones cada segundo
		if (Math.random() < 0.016) {  // ~1 vez por segundo a 60 FPS
			console.log('Game State:', {
				ball: gameState.ball,
				paddle1: gameState.paddles.player1,
				paddle2: gameState.paddles.player2,
				score: gameState.score
			});
		}
	}

		// Render loop
		setInterval(render, 1000 / 60);

		// ========================================
		// LOGGING
		// ========================================

		function log(message, type = 'info') {
			const logEl = document.getElementById('log');
			const time = new Date().toLocaleTimeString();
			logEl.innerHTML += `[${time}] ${message}\n`;
			logEl.scrollTop = logEl.scrollHeight;
			console.log(message);
		}

		// ========================================
		// UI UPDATES
		// ========================================

		function updateStatus(connected) {
			const statusEl = document.getElementById('status');
			if (connected) {
				statusEl.className = 'status connected';
				statusEl.textContent = 'üü¢ Connected';
			} else {
				statusEl.className = 'status disconnected';
				statusEl.textContent = '‚ö´ Disconnected';
			}
		}

		function updateInfoPanel(data) {
			if (data.roomId) {
				document.getElementById('displayRoomId').textContent = data.roomId;
			}
			if (data.playerNumber) {
				myPlayerNumber = data.playerNumber;
				document.getElementById('displayPlayerNum').textContent = `P${data.playerNumber}`;
			}
			if (data.totalPlayers !== undefined) {
				document.getElementById('displayPlayers').textContent = `${data.totalPlayers}/2`;
			}
		}

		function updateLatency(ms) {
			document.getElementById('displayLatency').textContent = `${ms}ms`;
		}

		function showCountdown(count) {
			const overlay = document.getElementById('countdownOverlay');
			const number = document.getElementById('countdownNumber');

			number.textContent = count;
			overlay.style.display = 'flex';

			setTimeout(() => {
				overlay.style.display = 'none';
			}, 900);
		}

		function showGameOver(winner, finalScores) {
			const overlay = document.getElementById('gameOverOverlay');
			const winnerText = document.getElementById('winnerText');

			if (winner === myPlayerNumber) {
				winnerText.textContent = 'üèÜ YOU WIN! üèÜ';
			} else {
				winnerText.textContent = 'üòî YOU LOSE';
			}

			overlay.style.display = 'flex';

			setTimeout(() => {
				overlay.style.display = 'none';
			}, 5000);
		}

		// ========================================
		// API
		// ========================================

		async function createRoom() {
			try {
				log('Creating room...');
				const response = await fetch('http://localhost:3002/api/rooms', {
					method: 'POST'
				});
				const data = await response.json();

				if (data.success) {
					document.getElementById('roomId').value = data.roomId;
					log(`‚úÖ Room created: ${data.roomId}`);
					updateInfoPanel({ roomId: data.roomId });
				}
			} catch (error) {
				log(`‚ùå Error: ${error.message}`);
			}
		}

		// ========================================
		// WEBSOCKET
		// ========================================

		function connect() {
			const roomId = document.getElementById('roomId').value.trim().toUpperCase();
			const playerId = document.getElementById('playerId').value.trim();
			const username = document.getElementById('username').value.trim();

			if (!roomId || roomId.length !== 6) {
				alert('Enter a valid 6-character room code');
				return;
			}

			const wsUrl = `ws://localhost:3002/ws/remote?roomId=${roomId}&playerId=${playerId}&username=${encodeURIComponent(username)}`;

			log(`Connecting to ${wsUrl}`);

			ws = new WebSocket(wsUrl);

			ws.onopen = () => {
				log('‚úÖ Connected!');
				updateStatus(true);
				startLatencyMonitor();
			};

			ws.onmessage = (event) => {
				const data = JSON.parse(event.data);
				handleMessage(data);
			};

			ws.onerror = (error) => {
				log(`‚ùå Error: ${error}`);
				updateStatus(false);
			};

			ws.onclose = () => {
				log('‚ö´ Disconnected');
				updateStatus(false);
				stopLatencyMonitor();
				gameState = null;
			};
		}

		function disconnect() {
			if (ws) {
				ws.close();
				ws = null;
				stopLatencyMonitor();
			}
		}

		function handleMessage(data) {
			switch (data.type) {
				case 'init':
					log(`‚úÖ Joined as Player ${data.playerNumber}`);
					updateInfoPanel({
						roomId: data.roomId,
						playerNumber: data.playerNumber,
						totalPlayers: data.roomInfo.totalPlayers
					});
					break;

				case 'playerJoined':
					log(`üëã Player ${data.playerNumber} joined`);
					updateInfoPanel({ totalPlayers: data.totalPlayers });
					break;

				case 'playerReady':
					log(`‚úÖ Player ${data.playerNumber} is ready`);
					break;

				case 'countdown':
					log(`‚è∞ ${data.count}...`);
					showCountdown(data.count);
					break;

				case 'gameStart':
					log(`üéÆ GAME START!`);
					gameState = data.gameState;
					break;

				case 'gameState':
					gameState = data.state;
					break;

				case 'score':
					log(`‚ö° SCORE! P${data.scorer}`);
					break;

				case 'gameEnd':
					log(`üèÜ Game Over! Winner: P${data.winner}`);
					showGameOver(data.winner, data.finalScores);
					break;

				case 'pong':
					const latency = Date.now() - data.timestamp;
					updateLatency(latency);
					break;

				case 'error':
					log(`‚ùå ${data.message}`);
					break;
			}
		}

		function send(message) {
			if (!ws || ws.readyState !== WebSocket.OPEN) {
				log('‚ùå Not connected');
				return;
			}
			ws.send(JSON.stringify(message));
		}

		function sendReady() {
			send({ type: 'ready' });
			log('‚úÖ Marked as ready');
			document.getElementById('readyBtn').disabled = true;
		}

		function sendPaddleMove(direction) {
			send({ type: 'paddleMove', direction });
		}

		function startLatencyMonitor() {
			latencyInterval = setInterval(() => {
				if (ws && ws.readyState === WebSocket.OPEN) {
					send({ type: 'ping', timestamp: Date.now() });
				}
			}, 2000);
		}

		function stopLatencyMonitor() {
			if (latencyInterval) {
				clearInterval(latencyInterval);
				latencyInterval = null;
			}
		}

		// ========================================
		// KEYBOARD CONTROLS - CORREGIDO
		// ========================================

		let keysPressed = {};

		document.addEventListener('keydown', (e) => {
			// ‚úÖ PREVENIR SCROLL CON FLECHAS
			if (e.key === 'ArrowUp' || e.key === 'ArrowDown' ||
				e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
				e.preventDefault();
			}

			if (!ws || ws.readyState !== WebSocket.OPEN) return;
			if (!gameState) return;

			if (e.key === 'ArrowUp' && !keysPressed['ArrowUp']) {
				keysPressed['ArrowUp'] = true;
				sendPaddleMove('up');
			} else if (e.key === 'ArrowDown' && !keysPressed['ArrowDown']) {
				keysPressed['ArrowDown'] = true;
				sendPaddleMove('down');
			}
		});

		document.addEventListener('keyup', (e) => {
			// ‚úÖ PREVENIR SCROLL CON FLECHAS
			if (e.key === 'ArrowUp' || e.key === 'ArrowDown' ||
				e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
				e.preventDefault();
			}

			if (!ws || ws.readyState !== WebSocket.OPEN) return;

			if (e.key === 'ArrowUp') {
				keysPressed['ArrowUp'] = false;
				sendPaddleMove('stop');
			} else if (e.key === 'ArrowDown') {
				keysPressed['ArrowDown'] = false;
				sendPaddleMove('stop');
			}
		});

		log('üéÆ Ready to play!');
	</script>
	
	<button onclick="testPaddle()" class="btn-primary">üß™ Test Paddle</button>
	
	<script>
		function testPaddle() {
			console.log('Testing paddle move...');
			console.log('WebSocket state:', ws?.readyState);
			console.log('Game state exists:', !!gameState);

			if (ws && ws.readyState === WebSocket.OPEN) {
				sendPaddleMove('up');
				console.log('‚úÖ Sent paddle up');
			} else {
				console.log('‚ùå Cannot send: WebSocket not ready');
			}
		}
	</script>
</body>

</html>